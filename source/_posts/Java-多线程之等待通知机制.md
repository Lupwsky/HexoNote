---
title: Java-多线程之等待通知机制
date: 2018-05-15 22:13:45
categories: Java
---

线程和线程之间通过同步来实现数据的共享，线程和线程之间也可以相互通信和协作，在 Java 的线程中使用 wait/notify 的方式实现线程之间的通信。

# 等待/通知机制

在 Java 中，使用 Object 中的 wait 和 notify 方法来实现等待/通知。

## wait 方法

1. wait 方法是 Object 类的方法，使当前执行代码的线程进入等待状态，方法在调用的地方就会停止代码的执行，直到收到通知或者被中断；
2. wait 方法必须在同步方法或者同步代码块中调用，否则出现 IllegalMotitorStateException 异常；
3. wait 方法执行后，线程会立即释放锁，线程将再次和其他线程竞争获取锁。

<!-- more -->

## notify 方法

1. notify 方法是 Object 类的方法，用于唤醒处于等待状态的线程，如果有多个线程处于等待状态，随机唤醒一个线程执行；
2. nitify 方法必须在同步方法或者同步代码块中调用，否则出现 IllegalMotitorStateException 异常；
3. wait 方法执行后，线程会不会立即释放锁，线程在同步方法或同步代码块执行完成后才会释放锁，线程将再次和其他线程竞争获取锁。

## notifyAll 方法

notifyAll 方法可以使使用同一个对象调用 wait 方法的线程全部唤醒，进入可运行状态，优先级高的线程有大概率会先执行。

## 等待状态线程调用 interrupt 方法

当线程处于 wait 状态时，调用线程的 interrupt 方法出现 InterruptException 异常。

## 线程释放锁的情况

1. 执行完同步代码就会立即释放锁；
2. 执行同步代码出现异常会立即释放锁；
3. 在同步代码中调用 wait 方法会立即释放锁。

## 通知过早

在线程的 wait 方法调用之前就调用了 notify 方法，这种情况称之为通知过早，通知过早，会导致 wait 的线程永远无法被唤醒，使程序出现错误。

# 生产者/消费者模式

生产者/消费者模式是线程等待/通知机制的一种经典应用，下面的内容一步一步的实现一个生产者/消费者模式，解决途中遇到的问题。

# wait 和 sleep 的区别

sleep 方法需要指定等待的时间，它可以让当前正在执行的线程在指定的时间内暂停执行，进入阻塞状态，该方法既可以让其他同优先级或者高优先级的线程得到执行的机会，也可以让低优先级的线程得到执行机会。但是 sleep 方法不会释放锁标志，也就是说如果有 synchronized 同步块，其他线程仍然不能访问共享数据。

wait 方法会释放对象的锁，当调用某一对象的 wait 方法后，会使当前线程暂停执行，并将当前线程放入对象等待池中，直到调用了 notify 方法后。此外，wait 方法必须